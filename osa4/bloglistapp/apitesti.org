* API calls for users
#+NAME: list_users
* Users
** List users
#+begin_src restclient
GET http://localhost:3003/api/users
#+end_src

#+RESULTS:
#+BEGIN_SRC js
[
  {
    "username": "ka",
    "name": "Karl Ankka",
    "id": "62a85c866b71183324e61660"
  },
  {
    "username": "",
    "name": "Palle Ankka",
    "id": "62aadd976b71183324e61665"
  }
]
// GET http://localhost:3000/api/users
// HTTP/1.1 200 OK
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 140
// ETag: W/"8c-Je/E5vieHkML3q+6hIjOduvFHyo"
// Date: Thu, 16 Jun 2022 07:37:07 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.062372s
#+END_SRC

** Create user
#+NAME: create_user
#+begin_src restclient
POST http://localhost:3000/api/users
Content-Type: application/json
{
  "username": "karl",
  "name": "Karl Kustaa",
  "password": "salaslasdfasdlfjalsalalala"
}
#+end_src

#+RESULTS: create_user
#+BEGIN_SRC js
{
  "username": "karl",
  "name": "Karl Kustaa",
  "id": "63187fb5bfe8263c403a40fd"
}
// POST http://localhost:3000/api/users
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 72
// ETag: W/"48-WVP79yX4d0zHBGN2nLovDUC/D/E"
// Date: Wed, 07 Sep 2022 11:25:41 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.102286s
#+END_SRC

#+NAME: create_user2
#+begin_src restclient
POST http://localhost:3000/api/users
Content-Type: application/json
{
  "username": "blogginfan",
  "name": "Virpi Virveli",
  "password": "tosihyväsalasana"
}
#+end_src

#+RESULTS: create_user2
#+BEGIN_SRC js
{
  "blogs": [],
  "username": "blogginfan",
  "name": "Virpi Virveli",
  "id": "631b52603a9c557ef2235f8c"
}
// POST http://localhost:3000/api/users
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 91
// ETag: W/"5b-z7WxcpOHwZnYZvn5oE9t+TQBKEU"
// Date: Fri, 09 Sep 2022 14:49:04 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.170682s
#+END_SRC

#+NAME: create_user3
#+begin_src restclient
POST http://localhost:3000/api/users
Content-Type: application/json
{
  "username": "yetanotheruser",
  "name": "Katariina Suuri",
  "password": "suurtakinsuurempisalaisuus"
}
#+end_src

#+RESULTS: create_user3
#+BEGIN_SRC js
{
  "error": "username must be unique"
}
// POST http://localhost:3000/api/users
// HTTP/1.1 400 Bad Request
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 35
// ETag: W/"23-dMOcSs8vZ/uesN0cuPdC8EaSTAE"
// Date: Sun, 11 Sep 2022 08:52:02 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.131463s
#+END_SRC

#+RESULTS: testi

** Test user pw reqs
#+NAME: create_user_short_pw
#+begin_src restclient
POST http://localhost:3000/api/users
Content-Type: application/json
{
  "username": "",
  "name": "Karl Ankka",
  "password": "kakakkakakakaka"
}
#+end_src

#+RESULTS: create_user_short_pw
#+BEGIN_SRC js
{
  "error": "Please choose a username of length 3 or longer"
}
// POST http://localhost:3000/api/users
// HTTP/1.1 400 Bad Request
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 58
// ETag: W/"3a-cBeRWqqfrqc+XTrTlLCvnQLoLaE"
// Date: Thu, 16 Jun 2022 07:43:52 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.018587s
#+END_SRC

* Blogs
** List  blogs
** Create blog
   :PROPERTIES:
   :header-args+: :var token="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImJsb2dnaW5mYW4iLCJpZCI6IjYzMWI1MjYwM2E5YzU1N2VmMjIzNWY4YyIsImlhdCI6MTY2MjczNTE5M30.S7sLfkRI-ee-Iyl3SjzlwjEa_p0WX7VbOF29Fjk_9OU"
   :END:

#+NAME: save-login
#+begin_src elisp :var token='toksu'
(defun chomp (str)
  "Chomp leading and trailing whitespace from STR."
  (while (string-match "\\'\n+\\|^\\s-+\\|\\s-+$\\|\n+\\'"
                       str)
    (setq str (replace-match "" t t str)))
  str)

(org-set-property "header-args+" (concat ":var token=" (json-encode (chomp token))))
#+end_src

#+NAME: login
#+begin_src restclient :results value :cache yes
POST http://localhost:3000/api/login
Content-type: application/json
{
  "username": "yetanotheruser",
  "password": "suurtakinsuurempisalaisuus"
}
#+end_src

#+RESULTS[ea4d035ae59b88708391c6678685a82d4c5791a9]: login
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImJsb2dnaW5mYW4iLCJpZCI6IjYzMWI1MjYwM2E5YzU1N2VmMjIzNWY4YyIsImlhdCI6MTY2MjczNTE5M30.S7sLfkRI-ee-Iyl3SjzlwjEa_p0WX7VbOF29Fjk_9OU",
  "username": "blogginfan",
  "name": "Virpi Virveli"
}

#+NAME: token
#+begin_src shell :stdin login
jq '.token'
#+end_src

Save token using save-login:
#+call: save-login(token=token)

#+RESULTS:

#+RESULTS: token
: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImthcmwiLCJpZCI6IjYzMTg3ZmI1YmZlODI2M2M0MDNhNDBmZCIsImlhdCI6MTY2MjcyNjM2OH0.ATw9c0LL1OJr_MAesGYcIZVdJa5ejwQPohnnAJjEJ6Q

#+NAME: create_blog
#+begin_src restclient
POST http://localhost:3000/api/blogs
Content-Type: application/json
Authorization: Bearer :token
{
  "title": "Testiblogi 2 - Sähköinen boogaloo",
  "author": "Bertil Blogger",
  "url": "www.blogi.fi/toimiikouserextractor"
}
#+end_src

#+RESULTS: create_blog
#+BEGIN_SRC js
{
  "title": "Testiblogi 2 - Sähköinen boogaloo",
  "author": "Bertil Blogger",
  "url": "www.blogi.fi/toimiikouserextractor",
  "user": "631b52603a9c557ef2235f8c",
  "likes": 0,
  "id": "631b7418c8e43ac7770a3753"
}
// POST http://localhost:3000/api/blogs
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 192
// ETag: W/"c0-Fd18Ypbkigqhvt1YdhfGSc40Y2U"
// Date: Fri, 09 Sep 2022 17:12:56 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.098824s
#+END_SRC

#+NAME: create_blog2
#+begin_src restclient
POST http://localhost:3000/api/blogs
Content-Type: application/json
Authorization: Bearer :token
{
  "title": "Joku kirjoitus",
  "author": "Bertil Blogger",
  "url": "www.blogi.fi/kuutio"
}
#+end_src

#+RESULTS: create_blog2
#+BEGIN_SRC js
{
  "title": "Joku kirjoitus",
  "author": "Bertil Blogger",
  "url": "www.blogi.fi/kuutio",
  "user": "63187fb5bfe8263c403a40fd",
  "likes": 0,
  "id": "631b518b3a9c557ef2235f7a"
}
// POST http://localhost:3000/api/blogs
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 156
// ETag: W/"9c-iclZV3GYIoxEwIWOYzX/2TNfPl4"
// Date: Fri, 09 Sep 2022 14:45:31 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.084611s
#+END_SRC

#+NAME: create_blog_reactpatterns
#+begin_src restclient
POST http://localhost:3000/api/blogs
Content-Type: application/json
Authorization: Bearer :token
{
  "title": "React Patterns",
  "author": "Michael Chan",
  "url": "https://www.reactpatterns.com"
}
#+end_src

#+RESULTS: create_blog_reactpatterns
#+BEGIN_SRC js
{
  "title": "React Patterns",
  "author": "Michael Chan",
  "url": "https://www.reactpatterns.com",
  "user": "63187fb5bfe8263c403a40fd",
  "likes": 0,
  "id": "631b51d03a9c557ef2235f84"
}
// POST http://localhost:3000/api/blogs
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 164
// ETag: W/"a4-dXFOKdRmqKwHfQL3MZeA6axf2S4"
// Date: Fri, 09 Sep 2022 14:46:40 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.058831s
#+END_SRC

#+NAME: create_blog_gotostatement
#+begin_src restclient
POST http://localhost:3000/api/blogs
Content-Type: application/json
Authorization: Bearer :token
{
  "title": "Go To Statement Considered Harmful",
  "author": "Edsger W. Dijkstra",
  "url": "http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html"
}
#+end_src

#+RESULTS: create_blog_gotostatement
#+BEGIN_SRC js
{
  "title": "Go To Statement Considered Harmful",
  "author": "Edsger W. Dijkstra",
  "url": "http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html",
  "user": "63187fb5bfe8263c403a40fd",
  "likes": 0,
  "id": "631b51df3a9c557ef2235f88"
}
// POST http://localhost:3000/api/blogs
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 246
// ETag: W/"f6-9BPwcQGDM3kvL2MpMad7W51+LWs"
// Date: Fri, 09 Sep 2022 14:46:55 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.042624s
#+END_SRC

#+NAME: create_blog_canonicalstringreduction
#+begin_src restclient
POST http://localhost:3000/api/blogs
Content-Type: application/json
Authorization: Bearer :token
{
  "title": "Canonical string reduction",
  "author": "Edsger W. Dijkstra",
  "url": "http://www.cs.utexas.edu/~EWD/transcriptions/EWD08xx/EWD808.html"
}
#+end_src

#+RESULTS: create_blog_canonicalstringreduction
#+BEGIN_SRC js
{
  "title": "Canonical string reduction",
  "author": "Edsger W. Dijkstra",
  "url": "http://www.cs.utexas.edu/~EWD/transcriptions/EWD08xx/EWD808.html",
  "user": "631b52603a9c557ef2235f8c",
  "likes": 0,
  "id": "631b53b03a9c557ef2235f90"
}
// POST http://localhost:3000/api/blogs
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 217
// ETag: W/"d9-SxduVamV/89PqRuHLLwYWQQUjuM"
// Date: Fri, 09 Sep 2022 14:54:40 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.049139s
#+END_SRC

#+NAME: create_blog_firstclasstests
#+begin_src restclient
POST http://localhost:3000/api/blogs
Content-Type: application/json
Authorization: Bearer :token
{
  "title": "First class tests",
  "author": "Robert C. Martin",
  "url": "http://blog.cleancoder.com/uncle-bob/2017/05/05/TestDefinitions.htmll"
}
#+end_src

#+RESULTS: create_blog_firstclasstests
#+BEGIN_SRC js
{
  "title": "First class tests",
  "author": "Robert C. Martin",
  "url": "http://blog.cleancoder.com/uncle-bob/2017/05/05/TestDefinitions.htmll",
  "user": "631b52603a9c557ef2235f8c",
  "likes": 0,
  "id": "631b53d53a9c557ef2235f96"
}
// POST http://localhost:3000/api/blogs
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 211
// ETag: W/"d3-jrO3QQP7RDW9caFWdGRXXBDaU+c"
// Date: Fri, 09 Sep 2022 14:55:17 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.030824s
#+END_SRC

#+NAME: create_blog_tddharmarchitecture
#+begin_src restclient
POST http://localhost:3000/api/blogs
Content-Type: application/json
Authorization: Bearer :token
{
  "title": "TDD harm architecture",
  "author": "Robert C. Martin",
  "url": "http://blog.cleancoder.com/uncle-bob/2017/03/03/TDD-Harms-Architecture.html"
}
#+end_src

#+RESULTS: create_blog_tddharmarchitecture
#+BEGIN_SRC js
{
  "title": "TDD harm architecture",
  "author": "Robert C. Martin",
  "url": "http://blog.cleancoder.com/uncle-bob/2017/03/03/TDD-Harms-Architecture.html",
  "user": "631b52603a9c557ef2235f8c",
  "likes": 0,
  "id": "631b53e33a9c557ef2235f9a"
}
// POST http://localhost:3000/api/blogs
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 221
// ETag: W/"dd-4JKNgpuxGqd+b9nacCU/eaz12RI"
// Date: Fri, 09 Sep 2022 14:55:31 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.044564s
#+END_SRC

#+NAME: create_blog_typewars
#+begin_src restclient
POST http://localhost:3000/api/blogs
Content-Type: application/json
Authorization: Bearer :token
{
  "title": "Type wars",
  "author": "Robert C. Martin",
  "url": "http://blog.cleancoder.com/uncle-bob/2016/05/01/TypeWars.html"
}
#+end_src

#+RESULTS: create_blog_typewars
#+BEGIN_SRC js
{
  "title": "Type wars",
  "author": "Robert C. Martin",
  "url": "http://blog.cleancoder.com/uncle-bob/2016/05/01/TypeWars.html",
  "user": "631b52603a9c557ef2235f8c",
  "likes": 0,
  "id": "631b53fd3a9c557ef2235f9e"
}
// POST http://localhost:3000/api/blogs
// HTTP/1.1 201 Created
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 195
// ETag: W/"c3-m+v9w5bWJrSFVkv26/Y37lcurVU"
// Date: Fri, 09 Sep 2022 14:55:57 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.026016s
#+END_SRC

Delete?
#+NAME: delete_blog_withtoken
#+begin_src restclient
DELETE http://localhost:3000/api/blogs/631b7418c8e43ac7770a3753
Content-Type: application/json
Authorization: Bearer :token
#+end_src

#+RESULTS: delete_blog_withtoken
#+BEGIN_SRC js
// DELETE http://localhost:3000/api/blogs/631b7418c8e43ac7770a3753
// HTTP/1.1 204 No Content
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Date: Fri, 09 Sep 2022 17:15:53 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.072783s
#+END_SRC

Delete without auth, should give sensible error (not internal server error!)
#+NAME: delete_blog_noauth
#+begin_src restclient
DELETE http://localhost:3000/api/blogs/631b53e33a9c557ef2235f9a
Content-Type: application/json
#+end_src

#+RESULTS: delete_blog_noauth
#+BEGIN_SRC js
{
  "error": "authorization failed"
}
// DELETE http://localhost:3000/api/blogs/631b53e33a9c557ef2235f9a
// HTTP/1.1 401 Unauthorized
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 32
// ETag: W/"20-5gimCzgctggSqndFzmdBvZfHpvY"
// Date: Sat, 10 Sep 2022 07:34:37 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.180079s
#+END_SRC

* Login
** Login test
#+NAME: test_login
#+begin_src restclient
POST http://localhost:3000/api/login
Content-type: application/json
{
  "username": "karl",
  "password": "salaslasdfasdlfjalsalalala"
}
#+end_src

#+RESULTS: test_login
#+BEGIN_SRC js
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImthcmwiLCJpZCI6IjYzMTg3ZmI1YmZlODI2M2M0MDNhNDBmZCIsImlhdCI6MTY2MjcwODg4OH0.3HVlvuyUbW_gKvmc28mg6ZlrWv2KUxKDTf6RvC5DGRI",
  "username": "karl",
  "name": "Karl Kustaa"
}
// POST http://localhost:3000/api/login
// HTTP/1.1 400 Bad Request
// X-Powered-By: Express
// Access-Control-Allow-Origin: *
// Content-Type: application/json; charset=utf-8
// Content-Length: 223
// ETag: W/"df-uGSgCF6gtCG64YjM8r1FvwQjseA"
// Date: Fri, 09 Sep 2022 07:34:48 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.086958s
#+END_SRC
